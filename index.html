<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento en Tiempo Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://openlayers.org/en/v6.5.0/css/ol.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #d16ba5, #86a8e7, #5ffbf1);
            min-height: 100vh;
            margin: 0;
        }

        #map {
            height: 60vh;
            width: 100%;
            margin-top: 20px;
        }

        .container {
            margin-top: 20px;
            text-align: center;
            color: white;
        }

        footer {
            background-color: #222;
            color: white;
            padding: 10px 0;
            width: 100%;
            text-align: center;
            position: fixed;
            bottom: 0;
            height: 56px;
            left: 0;
        }

        .btn-custom {
            border: 2px solid white;
            color: white;
            background-color: transparent;
            border-radius: 30px;
            padding: 10px 20px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            background-color: white;
            color: #333;
        }

        .input-custom {
            margin: 10px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Cero Distancia</a>
        </div>
    </nav>

    <div class="container">
        <h1>Seguimiento en Tiempo Real</h1>
        <div class="d-flex justify-content-center">
            <input type="text" id="nombre" class="input-custom" placeholder="Nombre del Repartidor">
            <input type="text" id="direccion" class="input-custom" placeholder="Dirección de Destino (Bariloche)">
        </div>
        <div class="d-flex justify-content-center">
            <button class="btn btn-custom" id="btn-empezar">Comenzar Búsqueda</button>
            <button class="btn btn-custom" id="btn-dejar-seguir">Dejar de Seguir</button>
            <button class="btn btn-custom" id="btn-enviar-whatsapp">Enviar Ubicación por WhatsApp</button>
            <button class="btn btn-custom" id="btn-whatsapp-llegada">WhatsApp de Llegada</button>
        </div>
        <div id="map"></div>
    </div>

    <footer>
        <p>Oscarsoft &copy; Derechos Reservados 2024</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://openlayers.org/en/v6.5.0/build/ol.js"></script>
    <script>
        let watchId;
        let vectorSource = new ol.source.Vector();
        let vectorLayer = new ol.layer.Vector({ source: vectorSource });
        let currentLat, currentLon; // Variables para almacenar la ubicación actual
        let map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({ source: new ol.source.OSM() }),
                vectorLayer
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-71.3103, -41.1335]),
                zoom: 12
            })
        });

        document.getElementById('btn-empezar').addEventListener('click', function() {
            const nombreRepartidor = document.getElementById('nombre').value;
            const direccionDestino = document.getElementById('direccion').value;
            
            if (!nombreRepartidor || !direccionDestino) {
                alert('Por favor, ingresa el nombre del repartidor y la dirección de destino.');
                return;
            }

            navigator.geolocation.getCurrentPosition(position => {
                currentLon = position.coords.longitude;
                currentLat = position.coords.latitude;

                // Centrar el mapa en la ubicación actual
                map.getView().setCenter(ol.proj.fromLonLat([currentLon, currentLat]));
                map.getView().setZoom(14);

                // Marcador de la ubicación actual
                const origenFeature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([currentLon, currentLat]))
                });
                origenFeature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({ color: 'green' }),
                        stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                    })
                }));
                vectorSource.addFeature(origenFeature);

                // Obtener coordenadas del destino usando Nominatim
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccionDestino)}, Bariloche`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const destino = [parseFloat(data[0].lon), parseFloat(data[0].lat)];

                            // Marcador del destino
                            const destinoFeature = new ol.Feature({
                                geometry: new ol.geom.Point(ol.proj.fromLonLat(destino))
                            });
                            destinoFeature.setStyle(new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 7,
                                    fill: new ol.style.Fill({ color: 'red' }),
                                    stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                                })
                            }));
                            vectorSource.addFeature(destinoFeature);

                            // Solicitar la ruta
                            fetch(`https://router.project-osrm.org/route/v1/driving/${currentLon},${currentLat};${destino[0]},${destino[1]}?overview=full&geometries=geojson`)
                                .then(response => response.json())
                                .then(routeData => {
                                    const route = new ol.format.GeoJSON().readFeature(routeData.routes[0].geometry, {
                                        featureProjection: 'EPSG:3857'
                                    });
                                    route.setStyle(new ol.style.Style({
                                        stroke: new ol.style.Stroke({
                                            color: '#FF5733',
                                            width: 3
                                        })
                                    }));
                                    vectorSource.addFeature(route);
                                });
                        } else {
                            alert('No se pudo encontrar la dirección ingresada.');
                        }
                    });
            }, errorUbicacion, { enableHighAccuracy: true, timeout: 5000 });

            // Iniciar seguimiento
            watchId = navigator.geolocation.watchPosition(position => {
                currentLon = position.coords.longitude;
                currentLat = position.coords.latitude;
            }, errorUbicacion, { enableHighAccuracy: true, maximumAge: 0 });
        });

        function errorUbicacion(error) {
            alert('Error al obtener la ubicación: ' + error.message);
        }

        document.getElementById('btn-dejar-seguir').addEventListener('click', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                alert('Seguimiento detenido.');
                location.reload(); // Recarga la página
            }
        });

        document.getElementById('btn-enviar-whatsapp').addEventListener('click', function() {
            const nombreRepartidor = document.getElementById('nombre').value;
            if (!nombreRepartidor || !currentLat || !currentLon) {
                alert('Inicia la búsqueda y asegúrate de ingresar el nombre del repartidor.');
                return;
            }

            const message = `Hola, soy ${nombreRepartidor}. Sigue mi ubicación en tiempo real: https://www.google.com/maps?q=${currentLat},${currentLon}`;
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;

            window.open(whatsappURL, '_blank');
        });

        document.getElementById('btn-whatsapp-llegada').addEventListener('click', function() {
            const nombreRepartidor = document.getElementById('nombre').value;
            if (!nombreRepartidor) {
                alert('Por favor, ingresa el nombre del repartidor.');
                return;
            }

            const message = `Hola, soy ${nombreRepartidor}. ¡Ya estoy en la puerta con tu pedido!`;
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;

            window.open(whatsappURL, '_blank');
        });
    </script>
</body>
</html>
